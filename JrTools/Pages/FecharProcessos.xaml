<?xml version="1.0" encoding="utf-8"?>
<Page
    x:Class="JrTools.Pages.FecharProcessos"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:local="using:JrTools.Pages"
    xmlns:models="using:JrTools.Models"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:viewmodels="using:JrTools.ViewModels"
    x:Name="RootPage"
    mc:Ignorable="d">

    <Page.Resources>
        <Style x:Key="ResponsiveCardStyle" TargetType="Border">
            <Setter Property="Background" Value="{ThemeResource CardBackgroundFillColorDefaultBrush}"/>
            <Setter Property="BorderBrush" Value="{ThemeResource CardStrokeColorDefaultBrush}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="CornerRadius" Value="8"/>
            <Setter Property="Padding" Value="16"/>
            <Setter Property="Margin" Value="8"/>
            <Setter Property="MinWidth" Value="320"/>
            <Setter Property="MaxWidth" Value="5000"/>
        </Style>

        <Style x:Key="FullWidthCardStyle" TargetType="Border" BasedOn="{StaticResource ResponsiveCardStyle}">
            <Setter Property="HorizontalAlignment" Value="Stretch"/>
        </Style>

        <!-- Template para o Botão individual de Processo -->
        <DataTemplate x:Key="ProcessButtonTemplate" x:DataType="viewmodels:ProcessViewModel">
            <ToggleButton 
                IsChecked="{x:Bind IsEnabled, Mode=TwoWay}"
                FontSize="16"
                Margin="10"
                Width="150" Height="150"
                HorizontalContentAlignment="Center" 
                VerticalContentAlignment="Center">
                <StackPanel>
                    <TextBlock Text="{x:Bind NameDisplay}" HorizontalAlignment="Center" TextAlignment="Center" TextWrapping="Wrap"/>
                    <TextBlock Text="{x:Bind Count, Mode=OneWay}" FontSize="24" HorizontalAlignment="Center" Margin="0,10,0,0"/>
                </StackPanel>
            </ToggleButton>
        </DataTemplate>

        <!-- Template para o Botão Master -->
        <DataTemplate x:Key="MasterButtonTemplate" x:DataType="viewmodels:ProcessViewModel">
            <ToggleButton 
                IsChecked="{Binding DataContext.IsAutoKillEnabled, ElementName=RootPage, Mode=TwoWay}"
                FontSize="16"
                Margin="10"
                Width="150" Height="150"
                Foreground="White"
                HorizontalContentAlignment="Center" 
                VerticalContentAlignment="Center">
                <TextBlock 
                   Text="{Binding NameDisplay}"
                   TextAlignment="Center"
                   VerticalAlignment="Center"
                   TextWrapping="Wrap"/>
            </ToggleButton>
        </DataTemplate>

        <local:ProcessCardTemplateSelector x:Key="CardSelector"
            MasterTemplate="{StaticResource MasterButtonTemplate}"
            ProcessTemplate="{StaticResource ProcessButtonTemplate}" />
    </Page.Resources>

    <Grid>
        <ScrollViewer VerticalScrollBarVisibility="Auto" Padding="16">
            <StackPanel Spacing="16">

                <TextBlock Text="Processos" Style="{ThemeResource TitleTextBlockStyle}" />

                <Border Style="{StaticResource FullWidthCardStyle}">
                    <StackPanel Spacing="10">
                        <TextBlock Text="Fechar Processos" FontWeight="Bold" FontSize="18"/>
                        
                        <!-- Lista Unificada de Botões -->
                        <ItemsControl x:Name="ProcessosItemsControl" 
                                      ItemsSource="{x:Bind ViewModel.MonitoredProcesses, Mode=OneWay}"
                                      ItemTemplateSelector="{StaticResource CardSelector}">
                            <ItemsControl.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <ItemsWrapGrid Orientation="Horizontal" MaximumRowsOrColumns="-1" ItemWidth="170" />
                                </ItemsPanelTemplate>
                            </ItemsControl.ItemsPanel>
                        </ItemsControl>
                    </StackPanel>
                </Border>

                <!-- DETALHES -->
                <Expander Header="Detalhes BPrv230" IsExpanded="True" HorizontalAlignment="Stretch" HorizontalContentAlignment="Stretch">
                    <StackPanel Spacing="16" Padding="16">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <TextBlock Text="Lista de processos em execução" VerticalAlignment="Center" Foreground="Gray"/>
                            <Button Grid.Column="1" x:Name="MatarProcessoButton" Content="Encerrar Individual" Click="MatarProcessoButton_Click" IsEnabled="False" Foreground="White" Background="Red"/>
                        </Grid>

                        <ListView x:Name="ProcessosDataGrid" 
                                  ItemsSource="{x:Bind ViewModel.BPrv230Details, Mode=OneWay}"
                                  SelectionMode="Single"
                                  SelectionChanged="ProcessosDataGrid_SelectionChanged"
                                  MinHeight="200">
                            <ListView.ItemTemplate>
                                <DataTemplate x:DataType="models:ProcessInfo">
                                    <Grid Padding="8">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="150"/>
                                            <ColumnDefinition Width="80"/>
                                            <ColumnDefinition Width="*"/>
                                        </Grid.ColumnDefinitions>
                                        <TextBlock Text="{x:Bind ProcessName}" FontWeight="Bold"/>
                                        <TextBlock Grid.Column="1" Text="{x:Bind PID}"/>
                                        <TextBlock Grid.Column="2" Text="{x:Bind CommandLine}" TextTrimming="CharacterEllipsis"/>
                                    </Grid>
                                </DataTemplate>
                            </ListView.ItemTemplate>
                        </ListView>
                    </StackPanel>
                </Expander>

                <!-- TERMINAL -->
                <Border Style="{StaticResource FullWidthCardStyle}">
                    <StackPanel Spacing="8">
                        <TextBlock Text="Progresso e Logs" FontWeight="Bold"/>
                        <Border Background="Black" Padding="10" CornerRadius="4">
                            <ScrollViewer x:Name="TerminalScrollViewer" Height="200">
                                <TextBlock x:Name="TerminalOutput" Text="{x:Bind ViewModel.Logs, Mode=OneWay}" Foreground="White" FontFamily="Consolas" TextWrapping="Wrap"/>
                            </ScrollViewer>
                        </Border>
                    </StackPanel>
                </Border>
            </StackPanel>
        </ScrollViewer>
    </Grid>
</Page>
